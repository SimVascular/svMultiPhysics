name: test_controller

on:
  pull_request:
  push:

jobs:
  check_for_changes:
    runs-on: ubuntu-latest
    outputs:
      run_full_tests: ${{ steps.set-outputs.outputs.run_full_tests }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            code:
              - 'Code/**'
            tests:
              - 'tests/**'
      - name: Set consolidated outputs
        id: set-outputs
        env:
          CODE: ${{ steps.filter.outputs.code || 'false' }}
          TESTS: ${{ steps.filter.outputs.tests || 'false' }}
        run: |
          if [ "${CODE}" = "true" ] || [ "${TESTS}" = "true" ]; then
            RUN_FULL_TESTS=true
          else
            RUN_FULL_TESTS=false
          fi
          echo "run_full_tests=${RUN_FULL_TESTS}" >> "$GITHUB_OUTPUT"

  # Dummy job that always passes when no code/tests changed
  test:
    needs: check_for_changes
    if: ${{ needs.check_for_changes.outputs.run_full_tests == 'false' }}
    runs-on: ubuntu-latest
    steps:
      - name: No relevant changes
        run: echo "âœ… Docs-only change, skipping tests."

  # Call Ubuntu reusable workflow
  test-ubuntu:
    needs: check_for_changes
    if: ${{ needs.check_for_changes.outputs.run_full_tests == 'true' }}
    uses: ./.github/workflows/test_ubuntu.yml

  # Call macOS reusable workflow
  test-macos:
    needs: check_for_changes
    if: ${{ needs.check_for_changes.outputs.run_full_tests == 'true' }}
    uses: ./.github/workflows/test_macos.yml
